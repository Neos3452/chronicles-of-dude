<!DOCTYPE html>
<html>
<head>
<script src="http://code.createjs.com/easeljs-0.7.0.min.js"></script>
<script src="http://code.createjs.com/preloadjs-0.4.1.min.js"></script>
<script type="text/javascript" src="utils.js"></script>
<script type="text/javascript" src="player.js"></script>
	<script type="text/javascript">
	
		var stage;
		var canvas;
		var gamepadText;
		var player;
		var ground;
		var scale = (112 + 56) / 1.8;
		var gravity = 10;
		var right = false, left = false, up = false;
		var mouseLocation;
		
		var loadQueue;
		var playerGamepad = undefined;
		
		function init() {
		    this.loadQueue = new createjs.LoadQueue(false);
		    this.loadQueue.on("complete", loadingComplete, this);
		    this.loadQueue.loadManifest([
		        {id:"torso",    src:"torso_sprite_6.png"},
		        {id:"head",     src:"head.png"},
		        {id:"sleeve",   src:"sleeve.png"},
		        {id:"forearm",  src:"arm.png"},
		        {id:"weapon",	src:"weapon.png"}
		    ]);
		    this.loadQueue.load();
		}
		
		function loadingComplete() {
		    console.log("loading complete!");
			this.canvas = document.getElementById("demoCanvas");
			//this.canvas.getContext("2d").translate(0.5, 0.5);
			this.mouseLocation = {
		        x: canvas.width,
		        y: canvas.height/2
		    };
			this.gamepadText = document.getElementById("noGamepad");
			window.addEventListener('keydown', dokeydown, true);
			window.addEventListener('keyup', dokeyup, true);
			window.addEventListener('webkitgamepadconnected',
                              onGamepadConnect);
            window.addEventListener('webkitgamepaddisconnected',
                              onGamepadDisconnect);
			
			this.stage = new createjs.Stage("demoCanvas");
			
			ground = this.canvas.height - 20;
			var groundRect = new createjs.Shape();
			groundRect.graphics.beginFill("brown").drawRect(0, ground, this.canvas.width, 20);
			this.stage.addChild(groundRect);
			
			
			var playerTorso = new createjs.SpriteSheet({
				images: [loadQueue.getResult("torso")],
				frames: {width: 103, height: 112, regX:45, regY:110},
				animations: {    
					run: {
					 frames:[2, 3, 2, 4, 5, 4],
					 next: "run",
					 speed: 0.35
					 },
					backward_run: {
					 frames:[4, 5, 4, 2, 3, 2],
					 next: "backward_run",
					 speed: 0.35
					 },
					step: 1,
					stand: 0,
					jump: 3
				}
			});
			this.runAnimation = playerTorso.getAnimation("run");
			var playerHead = new createjs.Bitmap(loadQueue.getResult("head"));
			playerHead.x = 0;
			playerHead.y = -106;
			playerHead.regX = 15;
			playerHead.regY = playerHead.image.height - 4;
			playerHead.eyesX = playerHead.regX;
			playerHead.eyesY = -playerHead.image.height/2;
			var sprite = new createjs.Sprite(playerTorso, "run");
			this.player = new Character(sprite, playerHead);
			this.player.x = 200;
			this.player.y = 0;
			this.player.velocityX = 2.5;
			this.player.velocityY = 0.0;
			this.player.jumpVelocity = 4.0;
			this.player.midAir = false;
			this.player.way = 0;
			this.player.eyesY = playerHead.eyesY;
			this.player.height = 112;
			
			var forearm = new createjs.Bitmap(loadQueue.getResult("forearm"));
			forearm.regX = 5;
			forearm.regY = 5;
			forearm.length = Utils.vectorLength(forearm.image.width - forearm.regX, forearm.image.height - forearm.regY);
			forearm.x = 16;
			forearm.y = 15;
			var sleeve = new createjs.Bitmap(loadQueue.getResult("sleeve"));
			sleeve.regX = 5;
			sleeve.regY = 5;
			sleeve.length = Utils.vectorLength(sleeve.image.width - sleeve.regX, sleeve.image.height - sleeve.regY);
			var armLeft = new createjs.Container();
			armLeft.addChild(forearm, sleeve);
			armLeft.x = 22;
			armLeft.y = -100;
			armLeft.length = forearm.length + sleeve.length;
			
			armRight = armLeft.clone(true);
			armRight.x = -22;
			armRight.y = -100;
			armRight.length = forearm.length + sleeve.length;
			
			var weapon = new createjs.Bitmap(loadQueue.getResult("weapon"));
			weapon.regX = 42;
			weapon.regY = 21;
			
			this.player.addChild(armLeft);
			this.player.addChild(weapon);
			this.player.addChild(armRight);
			this.player.swapChildren(armLeft, playerHead);
			
			this.player.reg_lookAt = this.player.lookAt;
			this.player.lookAt = function (x, y) {
				this.scaleX = 1;
				var change = false;
				if (x < this.x) {
					var dx = this.x - x;
					x += 2*dx;
					change = true;
				}
				this.reg_lookAt(x,y);
				this.scaleX = 1;
				var F1 = {
					x: this.x + armLeft.x,
					y: this.y + armLeft.y,
				};
				var F2 = {
					x: this.x + armRight.x,
					y: this.y + armRight.y,
				};
				
				var a = Math.abs(F1.x - F2.x);
				var b = 2 * Math.sqrt(Math.pow(armLeft.length, 2) - Math.pow(a/2,2));
				a = a + 2 * (armLeft.length - a);
				var elipseCenter = {
					x: 0,
					y: 0
				}
				elipseCenter.x = F1.x - (F1.x - F2.x)/2;
				elipseCenter.y = F1.y - (F1.y - F2.y)/2;
				var direction = {
					x: x - elipseCenter.x,
					y: y - elipseCenter.y
				};
				var l = Utils.vectorLength(direction.x, direction.y);
				direction.x /= l;
				direction.y /= l;
	            var rot = Math.atan2(direction.y, direction.x);
				var elipseX = a/2 * Math.cos(rot);
				var elipseY = b/2 * Math.sin(rot);
				var leftRot = 57.2957795 * Math.atan2(elipseCenter.y + elipseY - F1.y, elipseCenter.x + elipseX - F1.x);
				var rigthRot = 57.2957795 * Math.atan2(elipseCenter.y + elipseY - F2.y, elipseCenter.x + elipseX - F2.x);
				if (this.scaleX < 0) {
				/*
			        leftRot -= 180;
			        leftRot *= -1;
			        rigthRot -= 180;
			        rigthRot *= -1;
			        */
			        armRight.rotation = -45 + leftRot;
				    armLeft.rotation = -45 + rigthRot;
					weapon.rotation = 57.2957795 * -rot + 180;
			    } else {
				    armLeft.rotation = -45 + leftRot;
				    armRight.rotation = -45 + rigthRot;
				var p = armRight.getChildAt(0).localToLocal(25, 27, player);
				weapon.x = p.x;
				weapon.y = p.y;
				weapon.scaleX = -1.2;
				    weapon.rotation = rigthRot;
				}
//				console.log(rot);
				if(change)
					this.scaleX = -1;
			}
			
//				this.player.stand();
			
			this.stage.addChild(this.player);
			
			createjs.Ticker.addEventListener("tick", dotick);
			createjs.Ticker.timingMode = createjs.Ticker.RAF_SYNCHED;
			createjs.Ticker.setFPS(30);
			this.stage.on("stagemousemove", mouseMoved);
		}
		
		function dotick(event) {
		    handleInput();
			var sec = event.delta/1000;
			if (player.y < ground) {
				player.velocityY += gravity * sec;
				player.midAir = true;
			} else {
				player.midAir = false;
			}
			
			if (player.velocityY > 0.00001 || player.velocityY < -0.00001) {
				player.y += scale * player.velocityY * sec;
				if (player.y > ground) {
					player.y = ground;
					player.velocityY = 0;
				}
				if (!player.isJumping())
					player.jump();
			}
			/*
			player.way = 0;
			if(right)
				player.way += 1;
			if(left)
				player.way -= 1;
			*/
			player.x += scale * player.velocityX * player.way * sec;
			if (player.x > canvas.width)
				player.x = 0;
			else if (player.x < 0)
				player.x = canvas.width;
			
			if (!player.midAir) {
				if (!player.isRunning()) {
					if (player.way != 0)
						player.run();
				}
				if (player.way == 0 && !player.isStanding()) {
					player.stand();
				}
			} 
			
			this.stage.update();
		}
		
		function handleInput() {
		    var jump = up, speed = 0.0, lookX = mouseLocation.x, lookY = mouseLocation.y;
		    if (left) speed += -1.0;
		    if (right) speed += 1.0;
		    up = false;
		    if(playerGamepad) {
		        speed = playerGamepad.axes[0];
		        jump = (playerGamepad.buttons[0] > 0.5);
		        var lookup = playerGamepad.axes[1];
		        runAnimation.speed = 0.3 * Math.abs(speed) + 0.10;
		        lookX = player.x + player.scaleX * 100 + 1000 * speed;
		        lookY = player.y - player.height + 1000 * lookup;
		    }
		    player.way = speed;
			player.lookAt(lookX, lookY);
	        if (jump && !player.midAir) {
		        player.velocityY = -4.0;
		    }
		}
		
		function dokeydown(event) {
			if (event.keyCode == 37) {
				left = true;
			} else if (event.keyCode == 39) {
				right = true;
			} else if (event.keyCode == 38) {
			    up = true;
			}
			return false;
		}
		
		function dokeyup(event) {
			if (event.keyCode == 37) {
				left = false;
			} else if (event.keyCode == 39) {
				right = false;
			}
			return false;
		}
		
		function mouseMoved(event) {
		    mouseLocation.x = event.stageX;
		    mouseLocation.y = event.stageY;
	    }
		
		function onGamepadConnect(event) {
		    if (event.index === 0) {
		        playerGamepad = event.gamepad;
		        gamepadText.style.visibility = "hidden";
		        canvas.style.visibility = "visible";
		    }
		}
		
		function onGamepadDisconnect(event) {
		    if (event.index === 0) {
		        playerGamepad = undefined;
		        gamepadText.style.visibility = "visible";
		        canvas.style.visibility = "hidden";
		    }
		}
	</script>
</head>
<body onLoad="init()">
    <p id="noGamepad" style="visibility:visible;">No gamepad connected, please connect gamepad</p>
	<canvas id="demoCanvas" width="700" height="300" style="visibility:visible;">
	No canvas support :(
	</canvas>
</body>
</html>
